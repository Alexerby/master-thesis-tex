%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  APPENDIX – MICROSIMULATION PIPELINE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% -------------------------------------------------------------------------
%  Introductory motivation 
% -------------------------------------------------------------------------


\newpage
% ========================================================================
\section[Microsimulation Pipeline]{Microsimulation Pipeline\footnote{\href{https://github.com/Alexerby/msc-thesis-code-v4}{Byström, A. E., \& Antonsdottir, M. S.} (2025). \texttt{msc-thesis-code-v4}. GitHub. \url{https://github.com/Alexerby/msc-thesis-code-v4}.}}
\label{appendix:microsimulation-pipeline}
% ========================================================================

This appendix documents the microsimulation pipeline used to construct the analysis dataset from raw SOEP extracts. The goal is to make each step in the process transparent, reproducible, and aligned with the legal and institutional rules governing student aid eligibility in Germany.

The pipeline is organized into five main components: a student module, a sociodemographic enrichment module, a student income module, an assets module, and a parental income module. These components interact as illustrated in Figure~\ref{fig:pipeline-overview}.

\begin{figure}[H]
  \centering
  \begin{tikzpicture}[node distance=1.0cm and 1.0cm]

  % Switched layout
  \node[pipelinebox] (income) at (0,0) {Income module};
  \node[pipelinebox, right=of income] (assets) {Assets module};

  \node[pipelinebox, left=of income] (sibling) {Sibling (long)};
  \node[pipelinebox, below=of sibling] (sibling_wide) {Sibling grouped (wide)};

  \node[pipelinebox, left=of sibling] (parent) {Parent income (long)};
  \node[pipelinebox, below=of parent] (parent_wide) {Parents joint income (wide)};

  % Center reference node
  \path (parent) -- (assets) coordinate[midway] (center);

  % Student module centered above the whole group
  \node[pipelinebox, above=of center] (student) {Student module};

  % Sociodemographic module (to the right of Student module)
  \node[pipelinebox, right=of student] (sociodemog) {Sociodemographic module};

  % BAföG Calculations module below income/parent_wide/assets
  \node[pipelinebox, below=2.2cm of income] (bafoeg) {BAföG Calculations};

  % Arrows from submodules to BAföG Calculations
  \draw[arrow] (income) -- (bafoeg);
  \draw[arrow] (assets) -- (bafoeg);
  \draw[arrow] (parent_wide.south)
    -- ++(0,-0.8)
    coordinate (pstep)
    -- ([yshift=0]bafoeg.west |- pstep)
    -- ++(0.01,0);
  \draw[arrow] (parent) -- (parent_wide);

  % Arrows for sibling flow
  \draw[arrow] (sibling) -- (sibling_wide);
  \draw[arrow] (sibling_wide) -- (parent_wide);

  % Arrows from Student module to all first-row modules
  \draw[arrow] (student) -- (income);
  \draw[arrow] (student) -- (assets);
  \draw[arrow] (student) -- (parent);
  \draw[arrow] (student) -- (sibling);

  \draw[<->, thin] (sociodemog) -- (student);

  \end{tikzpicture}
  \caption{End-to-end pipeline overview with grouped raw SOEP sources}
  \label{fig:pipeline-overview}
\end{figure}

Figure~\ref{fig:pipeline-overview} maps the complete microsimulation pipeline, from raw SOEP inputs through modular components to the final BAföG calculation. The remainder of this appendix explains each component in detail.

% -------------------------------------------------------------------------
\subsection{Sociodemographic Module}
% -------------------------------------------------------------------------

This module constructs basic demographic characteristics needed throughout the pipeline. It provides sex, age, federal state, and household type variables. The federal state is used to derive an East/West classification, relevant for BAföG eligibility rules.

Key data sources include:

\begin{itemize}
  \item \texttt{ppathl}: sex, birth year and month
  \item \texttt{hgen}: household type
  \item \texttt{regionl}: federal state of residence
\end{itemize}

These variables are merged into the student module and used in eligibility filtering, modeling allowances, and regional policy differences.

% -------------------------------------------------------------------------
\subsection{Student Module}
% -------------------------------------------------------------------------

The student module is the core unit of the microsimulation. 
It filters and prepares individuals from SOEP who qualify as students, and populates them with relevant characteristics for BAföG simulation. 
This includes education status, household composition, parental identifiers, employment, and relationship status.

It integrates inputs from multiple datasets:

\begin{itemize}
  \item Education and religion: from \texttt{pl} (\texttt{plg0012\_h}, \texttt{plh0258\_h})
  \item Living with parents: based on household and parent ID matches in \texttt{ppathl}
  \item Employment status: from \texttt{pgen} (\texttt{pgemplst})
  \item Number of children: counted from \texttt{bioparen} where the student appears as parent
  \item Partnership status: inferred from household records
\end{itemize}

The resulting dataset includes all eligible students, ready for downstream processing.

% -------------------------------------------------------------------------
\subsection{Student-Income Module}
% -------------------------------------------------------------------------

This module computes the student's BAföG-relevant income. It begins with gross labour income and applies the following processing steps:

\begin{itemize}
  \item Merges reported income from the relevant assessment year (typically the previous calendar year)
  \item Deduction of Werbungskosten (§~9a EStG)
  \item Social insurance allowance of (§~21 BAföG)
  \item Calculation and subtraction of income tax, church tax, and solidarity surcharge
  \item Comparison with personal exemption thresholds (§~23 BAföG)
\end{itemize}

The output is net income above allowances, which may reduce BAföG entitlements.

% -------------------------------------------------------------------------
\subsection{Assets Module}
% -------------------------------------------------------------------------

The assets module compiles student-owned assets from the \texttt{pwealth} dataset. This includes:

\begin{itemize}
  \item \textbf{Financial assets:} bank accounts, savings, stocks, and bonds (\texttt{f0100a}--\texttt{f0100e})
  \item \textbf{Real estate:} other property ownership and shares in real estate (\texttt{e0111a}--\texttt{e0111e})
  \item \textbf{Business assets:} stakes in private businesses or self-employment (\texttt{b0100a}--\texttt{b0100e})
  \item \textbf{Private insurances:} building loan contracts, life and pension insurance (\texttt{i0100a}--\texttt{i0100e})
  \item \textbf{Vehicles:} cars, motorcycles, and other personal transport (\texttt{v0100a}--\texttt{v0100e})
  \item \textbf{Tangible assets:} valuables such as jewelry, art, or furniture (\texttt{t0100a}--\texttt{t0100e})
  \item \textbf{Liabilities and debts:} total outstanding debt, excluding student loans (\texttt{w0011a}--\texttt{w0011e})
\end{itemize}

All components are aggregated into a student-level asset profile. This value is compared against the legally defined asset allowance to determine whether the individual exceeds the threshold and may be excluded from eligibility.

The legal basis for this assessment is §~29 of the Bundesausbildungsförderungsgesetz (BAföG), which specifies the applicable asset allowances (\emph{Freibeträge vom Vermögen}).

% -------------------------------------------------------------------------
\subsection{Parental-Income Module}
% -------------------------------------------------------------------------

This module estimates the amount that parents are expected to contribute to a student's support. It proceeds as follows:

\begin{itemize}
  \item Match student with parents using \texttt{bioparen}
  \item Extract gross income from \texttt{pgen}
  \item Deduct Werbungskosten and social insurance contributions
  \item Apply parental tax model and §~25 BAföG allowances (base, sibling, relationship)
\end{itemize}

If both parents are observed, their contributions are aggregated. The final value is the BAföG-relevant parental contribution.

% -------------------------------------------------------------------------
\subsection{BAföG Calculation}
% -------------------------------------------------------------------------

The final module brings together all student and parental variables to compute a theoretical BAföG entitlement. The following logic is applied:

\begin{itemize}
  \item Deduct student income from allowances
  \item Subtract parental contribution
  \item Exclude students who exceed asset thresholds
\end{itemize}

This results in an estimated monthly benefit, which can be compared to reported values to analyze take-up behavior and simulate reforms.

% -------------------------------------------------------------------------
\subsection{Variable Dictionary}
% -------------------------------------------------------------------------

\begin{longtable}{llll}
\caption{Variable Dictionary by Dataset} 
 \label{table:variable_dictionary} \\
\toprule
Dataset & Variable & Description & Data Type (semantic) \\
\midrule
\endfirsthead

\multicolumn{4}{l}{\textit{(continued from previous page)}} \\
\toprule
Dataset & Variable & Description & Data Type (semantic) \\
\midrule
\endhead

\bottomrule
\multicolumn{4}{r}{\textit{(continued on next page)}} \\
\endfoot

\bottomrule
\endlastfoot
\texttt{ppathl} & \texttt{pid} & Person identifier & int \\
\texttt{ppathl} & \texttt{hid} & Household ID & int \\
\texttt{ppathl} & \texttt{syear} & Survey year & date \\
\texttt{ppathl} & \texttt{gebjahr} & Year of birth & int \\
\texttt{ppathl} & \texttt{sex} & Sex & Categorical \\
\texttt{ppathl} & \texttt{gebmonat} & Month of birth & int \\
\texttt{ppathl} & \texttt{partner} & Partnership status & Categorical \\
\texttt{ppathl} & \texttt{migback} & Migration background & Categorical \\
\texttt{biosib} & \texttt{pid} & Person identifier & int \\
\texttt{biosib} & \texttt{sibpnr1--sibpnr11} & Sibling person numbers & int \\
\texttt{pl} & \texttt{pid} & Person identifier & int \\
\texttt{pl} & \texttt{syear} & Survey year & date \\
\texttt{pl} & \texttt{plg0012\_h} & Currently in education & Ordinal \\
\texttt{pl} & \texttt{plh0258\_h} & Religion / church membership & Categorical \\
\texttt{pl} & \texttt{plc0167\_h} & BAföG eligibility & Binary \\
\texttt{pl} & \texttt{plc0168\_h} & BAföG / scholarship (gross, monthly) & int \\
\texttt{pl} & \texttt{plg0014\_v5} & Education level, 1999--2008 & Ordinal \\
\texttt{pl} & \texttt{plg0014\_v6} & Education level, 2009-2012 & Ordinal \\
\texttt{pl} & \texttt{plg0014\_v7} & Education level, 2013--2022 & Ordinal \\
\texttt{pgen} & \texttt{pid} & Person identifier & int \\
\texttt{pgen} & \texttt{syear} & Survey year & date \\
\texttt{pgen} & \texttt{pglabgro} & Labour income (gross) & int \\
\texttt{pgen} & \texttt{pgemplst} & Employment status & Categorical \\
\texttt{pgen} & \texttt{pgpartnr} & Partner indicator & int \\
\texttt{pkal} & \texttt{pid} & Person identifier & int \\
\texttt{pkal} & \texttt{syear} & Survey year & date \\
\texttt{pkal} & \texttt{kal2a02} & Monthly rent including utilities & int \\
\texttt{pkal} & \texttt{kal2a03\_h} & Housing benefit & int \\
\texttt{pwealth} & \texttt{pid} & Person identifier & int \\
\texttt{pwealth} & \texttt{syear} & Survey year & date \\
\texttt{pwealth} & \texttt{f0100a--f0100e} & Financial assets & int \\
\texttt{pwealth} & \texttt{e0111a--e0111e} & Real estate (net value shares) & int \\
\texttt{pwealth} & \texttt{b0100a--b0100e} & Business assets & int \\
\texttt{pwealth} & \texttt{i0100a--i0100e} & Private insurances & int \\
\texttt{pwealth} & \texttt{v0100a--v0100e} & Vehicles & int \\
\texttt{pwealth} & \texttt{t0100a--t0100e} & Tangible assets & int \\
\texttt{pwealth} & \texttt{w0011a--w0011e} & Liabilities and debts & int \\
\texttt{bioparen} & \texttt{pid} & Person identifier & int \\
\texttt{bioparen} & \texttt{fnr} & Father’s person ID & int \\
\texttt{bioparen} & \texttt{mnr} & Mother’s person ID & int \\
\texttt{regionl} & \texttt{hid} & Household ID & int \\
\texttt{regionl} & \texttt{bula} & Federal state (Bundesland) & Categorical \\
\texttt{regionl} & \texttt{syear} & Survey year & date \\
\texttt{hgen} & \texttt{hid} & Household ID & int \\
\texttt{hgen} & \texttt{hgtyp1hh} & Household type & Categorical \\
\texttt{hgen} & \texttt{syear} & Survey year & date \\
\texttt{pequiv} & \texttt{pid} & Person identifier & int \\
\texttt{pequiv} & \texttt{istuy} & Student grants received & int \\
\texttt{pequiv} & \texttt{syear} & Survey year & date \\
\texttt{biol} & \texttt{pid} & Person identifier & int \\
\texttt{biol} & \texttt{pid} & Person identifier & int \\
\texttt{biol} & \texttt{syear} & Survey year & date \\
\texttt{biol} & \texttt{lb0267\_v1} & Employment Status & Categorical \\
\texttt{biol} & \texttt{syear} & Survey year & date \\
\texttt{biol} & \texttt{lb0285} & Number of Children & int \\
\end{longtable}
